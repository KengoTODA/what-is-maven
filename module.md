# モジュールでプロジェクトに構造を持ち込む

ある程度の規模になってくると、プロジェクトに構造と制約を持ち込んだほうが開発の効率が上がります。

Javaはクラスをまとめるための仕組みとしてパッケージを提供していますが、もう少し大きな枠組（コンポーネント単位、
サービス単位など）での構造化をしようとするとプロジェクトを分ける必要性が出てきます。

これを普通にやると分割されたプロジェクトの数だけVCSのリポジトリを用意して、pom.xmlを用意して、プロジェクト間の関係を
依存関係として記述して……というかなり複雑かつ管理が難しい方法を採ることになってしまいます。これではプロジェクトの間に
依存ライブラリの不整合が生じたり、ビルド手順が複雑化してメンテナンスが難しくなったりするでしょう。

例としてcore, batch, frontの3つにプロジェクトを分けた場合を考えましょう。ビルド手順は以下のようになります。
どの順番でビルドすれば良いのかをきちんと覚えておかないと、コンパイルエラーになったりひとつ古いバージョンに依存した状態で
テストしてしまったりといったトラブルが予想できます。

```sh
cd go/to/workspace
svn co http://repository/project-core && cd project-core && mvn install
cd go/to/workspace
svn co http://repository/project-batch && cd project-batch && mvn install
cd go/to/workspace
svn co http://repository/project-front && cd project-front && mvn install
```

Mavenは *モジュール* という、パッケージよりも大きくプロジェクトよりも小さい構造を提供しています。
モジュールの特徴は以下のとおりです。

* プロジェクトに含まれるすべてのモジュールで設定を統一できます。
    * バージョン
    * リモートリポジトリの場所
    * ライセンス
    * 利用プラグインのバージョンと設定
    * 依存ライブラリのバージョンとスコープ
    * etc.
* 関連モジュールを一度にビルドできます。
    * Mavenはモジュール間の依存関係を自動的に解析し、モジュールのビルド順を決定
    * プロジェクトに含まれるすべてのモジュールから必要なモジュールだけを取り出してビルド可能
* プラグインの適用範囲を制限できます。
    * プラグインはモジュール単位で作用するため、プロジェクトの一部分のみ
    * 例えば1プロジェクトからjarファイル・warファイル・earファイルを複数個生成可能
    * プロジェクト全体に作用するプラグインも存在（aggregateパラメータを利用した[pmd:pmd](http://maven.apache.org/plugins/maven-pmd-plugin/pmd-mojo.html)など）

例えば2013年9月現在、[Jenkins](https://github.com/jenkinsci/jenkins)はcore,maven-plugin,testといった合計7つのモジュールで構成されています。
これを題材として、マルチモジュール構成のプロジェクトにおけるmvnコマンドの使い方を紹介していきます。

## すべてのモジュールをビルドする

すべてのモジュールをinstallしたい場合は、普段どおりで構いません。モジュールのビルド順はMavenが計算してくれます。

```sh
mvn install
```

## 特定のモジュールだけをビルドする

`--projects`オプションを使うことで、特定のモジュールだけをビルドすることができます。
例えば次のコマンドはcoreモジュールだけをinstallします。

```sh
mvn install --projects core
```

なお`--projects`の代わりに`-pl`と短縮して書くことも可能です。

## 指定モジュールが依存しているモジュールもすべてビルドする

`--projects`オプションだけでは指定モジュールが依存しているモジュールはビルドされないため、それらの最新版を使っての
ビルドにはなりません。依存モジュールのビルドも必要な場合には、`--also-make`オプションを利用しましょう。
Mavenはモジュール間の依存関係を自動的に計算して、依存モジュールをどの順にビルドするべきかも判断してくれます。

例えばcoreモジュールとそれが依存するモジュールだけinstallしたい場合は、以下のようにコマンドを実行します。

```sh
mvn install --also-make --projects core
```

なお`--also-make`は`-am`と短縮して書くことも可能です。


## 指定モジュールに依存しているモジュールもすべてビルドする

自分がモジュールに加えた変更が他のモジュールに悪影響を与えていないことを確認するために、変更したモジュールに
依存するすべてのモジュールをビルドしたいこともあるでしょう。その場合は`--also-make-dependents`を使用します。

```sh
mvn install --also-make-dependents --projects core
```

なお`--also-make-dependents`は`-amd`と短縮して書くことも可能です。

## 途中のモジュールからビルドを再開（--resume-fromオプション）

ビルドが失敗してそれを修正した場合、ビルドを最初からやり直す必要はありません。修正したモジュールからビルドを再開することで、
ビルドにかかる時間を短縮することができます。ビルドを開始したいモジュールを`--resume-from`で指定してください。

```sh
mvn install --also-make --projects core --resume-from test
```

なお`--resume-from`は`-rf`と短縮して書くことも可能です。


## 並列ビルド（--threadsオプション）

Maven3では複数モジュールを同時にビルドする`--threads`オプションが提供されています。
非対応のプラグインがあること、実験的な実装であることに注意が必要ですが、CPUがボトルネックになっている
ビルドを高速化したい場合には検討できるかもしれません。

- [Parallel builds in Maven 3](https://cwiki.apache.org/confluence/display/MAVEN/Parallel+builds+in+Maven+3)
